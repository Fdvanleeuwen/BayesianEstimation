<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Florian van Leeuwen">

<title>Non-MCMC methods</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="Non-MCMC_methods_files/libs/clipboard/clipboard.min.js"></script>
<script src="Non-MCMC_methods_files/libs/quarto-html/quarto.js"></script>
<script src="Non-MCMC_methods_files/libs/quarto-html/popper.min.js"></script>
<script src="Non-MCMC_methods_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Non-MCMC_methods_files/libs/quarto-html/anchor.min.js"></script>
<link href="Non-MCMC_methods_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Non-MCMC_methods_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Non-MCMC_methods_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Non-MCMC_methods_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Non-MCMC_methods_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#preliminaries" id="toc-preliminaries" class="nav-link active" data-scroll-target="#preliminaries">Preliminaries</a></li>
  <li><a href="#an-example-predicting-students-math-performance." id="toc-an-example-predicting-students-math-performance." class="nav-link" data-scroll-target="#an-example-predicting-students-math-performance.">An example: Predicting students’ math performance.</a></li>
  <li><a href="#non-mcmc-methods" id="toc-non-mcmc-methods" class="nav-link" data-scroll-target="#non-mcmc-methods">Non-MCMC methods</a>
  <ul class="collapse">
  <li><a href="#running-models-direclty-in-cmdstanr" id="toc-running-models-direclty-in-cmdstanr" class="nav-link" data-scroll-target="#running-models-direclty-in-cmdstanr">Running models direclty in CMDSTANR</a></li>
  </ul></li>
  <li><a href="#original-computing-environment" id="toc-original-computing-environment" class="nav-link" data-scroll-target="#original-computing-environment">Original Computing Environment</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Non-MCMC methods</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Florian van Leeuwen </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<p>This document illustrates using different approximators in <code>Stan</code>, which is the program underlying various R-packages for Bayesian analysis, including <code>brms</code>.</p>
<section id="preliminaries" class="level2">
<h2 class="anchored" data-anchor-id="preliminaries">Preliminaries</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">07082023</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="an-example-predicting-students-math-performance." class="level2">
<h2 class="anchored" data-anchor-id="an-example-predicting-students-math-performance.">An example: Predicting students’ math performance.</h2>
<p>To illustrate Bayesian convergence and checks, we will use a data set that is available from the <a href="https://archive.ics.uci.edu">UCI Machine Learning repository</a>. The data set we use can be downloaded <a href="https://archive.ics.uci.edu/dataset/320/student+performance">here</a> and contains two data sets and a merged file. We will use the “student-mat.csv” file.</p>
<p>We will use linear regression analysis to predict the final math grade of Portugese students in secondary schools. First, we load in the data. Make sure the data is saved in your current working directory or change the path to the data in the code below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">"student-mat.csv"</span>, <span class="at">sep =</span> <span class="st">";"</span>, <span class="at">header =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  school sex age address famsize Pstatus Medu Fedu     Mjob     Fjob     reason
1     GP   F  18       U     GT3       A    4    4  at_home  teacher     course
2     GP   F  17       U     GT3       T    1    1  at_home    other     course
3     GP   F  15       U     LE3       T    1    1  at_home    other      other
4     GP   F  15       U     GT3       T    4    2   health services       home
5     GP   F  16       U     GT3       T    3    3    other    other       home
6     GP   M  16       U     LE3       T    4    3 services    other reputation
  guardian traveltime studytime failures schoolsup famsup paid activities
1   mother          2         2        0       yes     no   no         no
2   father          1         2        0        no    yes   no         no
3   mother          1         2        3       yes     no  yes         no
4   mother          1         3        0        no    yes  yes        yes
5   father          1         2        0        no    yes  yes         no
6   mother          1         2        0        no    yes  yes        yes
  nursery higher internet romantic famrel freetime goout Dalc Walc health
1     yes    yes       no       no      4        3     4    1    1      3
2      no    yes      yes       no      5        3     3    1    1      3
3     yes    yes      yes       no      4        3     2    2    3      3
4     yes    yes      yes      yes      3        2     2    1    1      5
5     yes    yes       no       no      4        3     2    1    2      5
6     yes    yes      yes       no      5        4     2    1    2      5
  absences G1 G2 G3
1        6  5  6  6
2        4  5  5  6
3       10  7  8 10
4        2 15 14 15
5        4  6 10 10
6       10 15 15 15</code></pre>
</div>
</div>
<p>We will predict the math grade at the third period <em>G3</em> based on all other available data and we will use a horseshoe prior to help induce some sparsity. This is a shrinkage priors that attempts to (mainly) shrink non-important predictors. For more information on the horseshoe prior see day 4 of this course and references <a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> <a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>hs_prior <span class="ot">&lt;-</span> <span class="fu">set_prior</span>(<span class="fu">horseshoe</span>(<span class="at">df =</span> <span class="dv">3</span>)) <span class="co"># select prior</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span> <span class="fu">brm</span>(G3 <span class="sc">~</span> ., <span class="at">data =</span> dat, <span class="at">algorithm =</span> <span class="st">"sampling"</span>, <span class="at">prior =</span> hs_prior, <span class="at">seed =</span> <span class="dv">123</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Compiling Stan program...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Start sampling</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 1).
Chain 1: 
Chain 1: Gradient evaluation took 5.7e-05 seconds
Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 0.57 seconds.
Chain 1: Adjust your expectations accordingly!
Chain 1: 
Chain 1: 
Chain 1: Iteration:    1 / 2000 [  0%]  (Warmup)
Chain 1: Iteration:  200 / 2000 [ 10%]  (Warmup)
Chain 1: Iteration:  400 / 2000 [ 20%]  (Warmup)
Chain 1: Iteration:  600 / 2000 [ 30%]  (Warmup)
Chain 1: Iteration:  800 / 2000 [ 40%]  (Warmup)
Chain 1: Iteration: 1000 / 2000 [ 50%]  (Warmup)
Chain 1: Iteration: 1001 / 2000 [ 50%]  (Sampling)
Chain 1: Iteration: 1200 / 2000 [ 60%]  (Sampling)
Chain 1: Iteration: 1400 / 2000 [ 70%]  (Sampling)
Chain 1: Iteration: 1600 / 2000 [ 80%]  (Sampling)
Chain 1: Iteration: 1800 / 2000 [ 90%]  (Sampling)
Chain 1: Iteration: 2000 / 2000 [100%]  (Sampling)
Chain 1: 
Chain 1:  Elapsed Time: 1.451 seconds (Warm-up)
Chain 1:                1.386 seconds (Sampling)
Chain 1:                2.837 seconds (Total)
Chain 1: 

SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 2).
Chain 2: 
Chain 2: Gradient evaluation took 1.3e-05 seconds
Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 0.13 seconds.
Chain 2: Adjust your expectations accordingly!
Chain 2: 
Chain 2: 
Chain 2: Iteration:    1 / 2000 [  0%]  (Warmup)
Chain 2: Iteration:  200 / 2000 [ 10%]  (Warmup)
Chain 2: Iteration:  400 / 2000 [ 20%]  (Warmup)
Chain 2: Iteration:  600 / 2000 [ 30%]  (Warmup)
Chain 2: Iteration:  800 / 2000 [ 40%]  (Warmup)
Chain 2: Iteration: 1000 / 2000 [ 50%]  (Warmup)
Chain 2: Iteration: 1001 / 2000 [ 50%]  (Sampling)
Chain 2: Iteration: 1200 / 2000 [ 60%]  (Sampling)
Chain 2: Iteration: 1400 / 2000 [ 70%]  (Sampling)
Chain 2: Iteration: 1600 / 2000 [ 80%]  (Sampling)
Chain 2: Iteration: 1800 / 2000 [ 90%]  (Sampling)
Chain 2: Iteration: 2000 / 2000 [100%]  (Sampling)
Chain 2: 
Chain 2:  Elapsed Time: 1.605 seconds (Warm-up)
Chain 2:                1.391 seconds (Sampling)
Chain 2:                2.996 seconds (Total)
Chain 2: 

SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 3).
Chain 3: 
Chain 3: Gradient evaluation took 1.2e-05 seconds
Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 0.12 seconds.
Chain 3: Adjust your expectations accordingly!
Chain 3: 
Chain 3: 
Chain 3: Iteration:    1 / 2000 [  0%]  (Warmup)
Chain 3: Iteration:  200 / 2000 [ 10%]  (Warmup)
Chain 3: Iteration:  400 / 2000 [ 20%]  (Warmup)
Chain 3: Iteration:  600 / 2000 [ 30%]  (Warmup)
Chain 3: Iteration:  800 / 2000 [ 40%]  (Warmup)
Chain 3: Iteration: 1000 / 2000 [ 50%]  (Warmup)
Chain 3: Iteration: 1001 / 2000 [ 50%]  (Sampling)
Chain 3: Iteration: 1200 / 2000 [ 60%]  (Sampling)
Chain 3: Iteration: 1400 / 2000 [ 70%]  (Sampling)
Chain 3: Iteration: 1600 / 2000 [ 80%]  (Sampling)
Chain 3: Iteration: 1800 / 2000 [ 90%]  (Sampling)
Chain 3: Iteration: 2000 / 2000 [100%]  (Sampling)
Chain 3: 
Chain 3:  Elapsed Time: 1.356 seconds (Warm-up)
Chain 3:                1.464 seconds (Sampling)
Chain 3:                2.82 seconds (Total)
Chain 3: 

SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 4).
Chain 4: 
Chain 4: Gradient evaluation took 1.9e-05 seconds
Chain 4: 1000 transitions using 10 leapfrog steps per transition would take 0.19 seconds.
Chain 4: Adjust your expectations accordingly!
Chain 4: 
Chain 4: 
Chain 4: Iteration:    1 / 2000 [  0%]  (Warmup)
Chain 4: Iteration:  200 / 2000 [ 10%]  (Warmup)
Chain 4: Iteration:  400 / 2000 [ 20%]  (Warmup)
Chain 4: Iteration:  600 / 2000 [ 30%]  (Warmup)
Chain 4: Iteration:  800 / 2000 [ 40%]  (Warmup)
Chain 4: Iteration: 1000 / 2000 [ 50%]  (Warmup)
Chain 4: Iteration: 1001 / 2000 [ 50%]  (Sampling)
Chain 4: Iteration: 1200 / 2000 [ 60%]  (Sampling)
Chain 4: Iteration: 1400 / 2000 [ 70%]  (Sampling)
Chain 4: Iteration: 1600 / 2000 [ 80%]  (Sampling)
Chain 4: Iteration: 1800 / 2000 [ 90%]  (Sampling)
Chain 4: Iteration: 2000 / 2000 [100%]  (Sampling)
Chain 4: 
Chain 4:  Elapsed Time: 1.443 seconds (Warm-up)
Chain 4:                1.403 seconds (Sampling)
Chain 4:                2.846 seconds (Total)
Chain 4: </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: There were 10 divergent transitions after warmup. See
https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup
to find out why this is a problem and how to eliminate them.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Examine the pairs() plot to diagnose sampling problems</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: There were 10 divergent transitions after warmup. Increasing
adapt_delta above 0.8 may help. See
http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity; sigma = identity 
Formula: G3 ~ school + sex + age + address + famsize + Pstatus + Medu + Fedu + Mjob + Fjob + reason + guardian + traveltime + studytime + failures + schoolsup + famsup + paid + activities + nursery + higher + internet + romantic + famrel + freetime + goout + Dalc + Walc + health + absences + G1 + G2 
   Data: dat (Number of observations: 395) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Regression Coefficients:
                 Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept           -1.30      1.54    -4.11     1.84 1.00     2771     2635
schoolMS             0.05      0.15    -0.17     0.44 1.00     4830     3435
sexM                 0.03      0.11    -0.16     0.29 1.00     5483     3476
age                 -0.11      0.08    -0.29     0.02 1.00     2310     2817
addressU            -0.00      0.10    -0.23     0.21 1.00     5755     3592
famsizeLE3           0.01      0.10    -0.19     0.25 1.00     6375     3768
PstatusT            -0.03      0.13    -0.36     0.19 1.00     6138     3373
Medu                 0.02      0.07    -0.10     0.18 1.00     5128     3720
Fedu                -0.02      0.07    -0.18     0.10 1.00     5352     3702
Mjobhealth          -0.00      0.12    -0.28     0.27 1.00     5837     3583
Mjobother            0.01      0.10    -0.20     0.23 1.00     5285     3504
Mjobservices         0.01      0.10    -0.21     0.24 1.00     6833     3439
Mjobteacher          0.00      0.12    -0.27     0.25 1.00     5466     3756
Fjobhealth           0.04      0.16    -0.21     0.47 1.00     4864     3265
Fjobother            0.04      0.11    -0.16     0.33 1.00     4308     2931
Fjobservices        -0.10      0.15    -0.50     0.10 1.00     3852     3477
Fjobteacher         -0.00      0.14    -0.31     0.30 1.00     5094     2890
reasonhome          -0.07      0.13    -0.41     0.10 1.00     4931     3116
reasonother          0.04      0.14    -0.19     0.41 1.00     5940     3685
reasonreputation     0.03      0.11    -0.16     0.30 1.00     5782     3754
guardianmother       0.06      0.12    -0.12     0.36 1.00     5184     3763
guardianother       -0.04      0.14    -0.39     0.21 1.00     4341     3796
traveltime           0.04      0.09    -0.11     0.26 1.00     5495     3730
studytime           -0.05      0.08    -0.25     0.08 1.00     5032     3619
failures            -0.08      0.11    -0.34     0.07 1.00     4153     3168
schoolsupyes         0.07      0.15    -0.15     0.48 1.00     4186     3322
famsupyes            0.03      0.11    -0.16     0.28 1.00     5069     3293
paidyes              0.02      0.10    -0.16     0.25 1.00     6206     3477
activitiesyes       -0.10      0.14    -0.45     0.08 1.00     3334     2979
nurseryyes          -0.03      0.11    -0.32     0.18 1.00     5684     3251
higheryes            0.03      0.15    -0.25     0.42 1.00     5188     3717
internetyes         -0.04      0.12    -0.34     0.16 1.00     5800     3531
romanticyes         -0.10      0.14    -0.45     0.09 1.00     3837     3151
famrel               0.26      0.12     0.01     0.49 1.00     2095     1162
freetime             0.03      0.06    -0.09     0.18 1.00     4813     3673
goout                0.01      0.06    -0.10     0.14 1.00     6175     3668
Dalc                -0.01      0.07    -0.19     0.14 1.00     5203     3923
Walc                 0.05      0.07    -0.05     0.22 1.00     4017     3649
health               0.03      0.05    -0.06     0.15 1.00     4154     3454
absences             0.04      0.01     0.01     0.06 1.00     2900     2425
G1                   0.14      0.06     0.01     0.25 1.00     3395     1644
G2                   1.00      0.05     0.89     1.10 1.00     3606     2510

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma     1.88      0.07     1.75     2.03 1.00     5601     2874

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>runtime1 <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that here, we rely on the default hyperparameter settings in <code>brms</code>.</p>
</section>
<section id="non-mcmc-methods" class="level2">
<h2 class="anchored" data-anchor-id="non-mcmc-methods">Non-MCMC methods</h2>
<p>By default <code>brms</code> uses HMC, where the NUTS algorithms <a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> is used to help with the sampling. In this case sampling is quite quick, but let’s say we are really busy and we want the model estimates even quicker.</p>
<p>In the mean field method in <code>Stan</code> independent Gaussians are assumed as the distributions for our latent variables in the unconstrained space. The last part might be a bit confusing, but imagine estimating a variance term with a Gaussian. We would run into the problem that there would be some density below zero, and this is impossible for a variance term. So, we could first transform the variable to become unconstrained (e.g., take the log) then estimate the Gaussian in this unconstrained space and subsequently back-transform the parameter to the original space. See footnote <a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> for more information.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>fit2 <span class="ot">&lt;-</span> <span class="fu">brm</span>(G3 <span class="sc">~</span> ., <span class="at">data =</span> dat, <span class="at">algorithm =</span> <span class="st">"meanfield"</span>, <span class="at">prior =</span> hs_prior, <span class="at">seed =</span> <span class="dv">123</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Compiling Stan program...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Start sampling</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 1: ------------------------------------------------------------
Chain 1: EXPERIMENTAL ALGORITHM:
Chain 1:   This procedure has not been thoroughly tested and may be unstable
Chain 1:   or buggy. The interface is subject to change.
Chain 1: ------------------------------------------------------------
Chain 1: 
Chain 1: 
Chain 1: 
Chain 1: Gradient evaluation took 5.1e-05 seconds
Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 0.51 seconds.
Chain 1: Adjust your expectations accordingly!
Chain 1: 
Chain 1: 
Chain 1: Begin eta adaptation.
Chain 1: Iteration:   1 / 250 [  0%]  (Adaptation)
Chain 1: Iteration:  50 / 250 [ 20%]  (Adaptation)
Chain 1: Iteration: 100 / 250 [ 40%]  (Adaptation)
Chain 1: Iteration: 150 / 250 [ 60%]  (Adaptation)
Chain 1: Iteration: 200 / 250 [ 80%]  (Adaptation)
Chain 1: Success! Found best value [eta = 1] earlier than expected.
Chain 1: 
Chain 1: Begin stochastic gradient ascent.
Chain 1:   iter             ELBO   delta_ELBO_mean   delta_ELBO_med   notes 
Chain 1:    100        -4787.992             1.000            1.000
Chain 1:    200        -1409.481             1.698            2.397
Chain 1:    300        -1063.746             1.361            2.397
Chain 1:    400         -904.832             0.250            0.325
Chain 1:    500         -866.982             0.110            0.176
Chain 1:    600         -868.700             0.023            0.044
Chain 1:    700         -861.113             0.005            0.009   MEAN ELBO CONVERGED   MEDIAN ELBO CONVERGED
Chain 1: 
Chain 1: Drawing a sample of size 1000 from the approximate posterior... 
Chain 1: COMPLETED.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Pareto k diagnostic value is 2. Resampling is disabled. Decreasing
tol_rel_obj may help if variational algorithm has terminated prematurely.
Otherwise consider using sampling instead.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity; sigma = identity 
Formula: G3 ~ school + sex + age + address + famsize + Pstatus + Medu + Fedu + Mjob + Fjob + reason + guardian + traveltime + studytime + failures + schoolsup + famsup + paid + activities + nursery + higher + internet + romantic + famrel + freetime + goout + Dalc + Walc + health + absences + G1 + G2 
   Data: dat (Number of observations: 395) 
  Draws: 1 chains, each with iter = 1000; warmup = 0; thin = 1;
         total post-warmup draws = 1000

Regression Coefficients:
                 Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept           -0.60      1.91    -3.70     3.88 1.00     1026      982
schoolMS             0.02      0.17    -0.29     0.38 1.00      955      881
sexM                 0.03      0.14    -0.20     0.34 1.00     1081      813
age                 -0.09      0.09    -0.35     0.02 1.00      965      934
addressU            -0.02      0.09    -0.25     0.13 1.00     1021      906
famsizeLE3           0.02      0.17    -0.28     0.36 1.00     1043     1014
PstatusT            -0.02      0.13    -0.29     0.19 1.00      992      950
Medu                 0.02      0.07    -0.09     0.17 1.00      911      706
Fedu                -0.00      0.07    -0.13     0.12 1.00     1009      797
Mjobhealth           0.00      0.27    -0.55     0.51 1.00      870      879
Mjobother            0.01      0.16    -0.28     0.32 1.00     1047      944
Mjobservices         0.00      0.11    -0.24     0.23 1.00      976      901
Mjobteacher          0.01      0.18    -0.26     0.31 1.00      995      919
Fjobhealth           0.02      0.26    -0.36     0.42 1.00      931      956
Fjobother            0.02      0.07    -0.09     0.20 1.00      981      745
Fjobservices        -0.04      0.15    -0.37     0.19 1.00     1030      869
Fjobteacher          0.01      0.16    -0.25     0.33 1.00      873      852
reasonhome          -0.04      0.11    -0.28     0.13 1.00     1065      979
reasonother          0.00      0.13    -0.25     0.28 1.00      993      689
reasonreputation     0.02      0.12    -0.19     0.31 1.00      946      823
guardianmother       0.04      0.13    -0.14     0.34 1.00      955     1026
guardianother       -0.02      0.17    -0.34     0.24 1.00      931      950
traveltime           0.02      0.11    -0.15     0.24 1.00      921      840
studytime           -0.02      0.09    -0.21     0.12 1.00     1101      941
failures            -0.10      0.18    -0.51     0.08 1.01      791      900
schoolsupyes         0.02      0.13    -0.19     0.28 1.00     1137     1065
famsupyes            0.01      0.11    -0.20     0.24 1.00      996      997
paidyes              0.02      0.10    -0.15     0.25 1.00      937      908
activitiesyes       -0.07      0.18    -0.46     0.14 1.00     1021      983
nurseryyes          -0.03      0.14    -0.35     0.22 1.00     1003     1017
higheryes            0.00      0.16    -0.34     0.35 1.00     1050      982
internetyes         -0.02      0.16    -0.37     0.25 1.00     1040      973
romanticyes         -0.05      0.10    -0.28     0.09 1.00      926      988
famrel               0.21      0.15     0.02     0.55 1.00      966      944
freetime             0.02      0.07    -0.10     0.19 1.00     1139     1072
goout                0.01      0.06    -0.13     0.13 1.00     1017      847
Dalc                -0.00      0.15    -0.26     0.34 1.00      967     1025
Walc                 0.03      0.11    -0.12     0.23 1.00     1058      983
health               0.01      0.06    -0.11     0.15 1.00      969     1021
absences             0.03      0.01     0.01     0.06 1.00      978      885
G1                   0.12      0.04     0.06     0.21 1.00     1003      909
G2                   0.94      0.05     0.86     1.03 1.00      981      841

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma     1.88      0.07     1.75     2.01 1.00     1126      979

Draws were sampled using variational(meanfield). </code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>runtime2 <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Alternatively, we can use the full-rank method that assumes a joint Gaussian for the latent variables. This might sound like an advantage, but note that this method models a covariance matrix with p * p elements, whereas meanfield only models the diagonal so p * 1. We will thus run into scaling problems when p (the number of latent variables) is large. The method is not very stable, try changing the seed to see what happens.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>fit3 <span class="ot">&lt;-</span> <span class="fu">brm</span>(G3 <span class="sc">~</span> ., <span class="at">data =</span> dat, <span class="at">algorithm =</span> <span class="st">"fullrank"</span>, <span class="at">prior =</span> hs_prior, <span class="at">seed =</span> <span class="dv">123</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Compiling Stan program...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Start sampling</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 1: ------------------------------------------------------------
Chain 1: EXPERIMENTAL ALGORITHM:
Chain 1:   This procedure has not been thoroughly tested and may be unstable
Chain 1:   or buggy. The interface is subject to change.
Chain 1: ------------------------------------------------------------
Chain 1: 
Chain 1: 
Chain 1: 
Chain 1: Gradient evaluation took 5.8e-05 seconds
Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 0.58 seconds.
Chain 1: Adjust your expectations accordingly!
Chain 1: 
Chain 1: 
Chain 1: Begin eta adaptation.
Chain 1: Iteration:   1 / 250 [  0%]  (Adaptation)
Chain 1: Iteration:  50 / 250 [ 20%]  (Adaptation)
Chain 1: Iteration: 100 / 250 [ 40%]  (Adaptation)
Chain 1: Iteration: 150 / 250 [ 60%]  (Adaptation)
Chain 1: Iteration: 200 / 250 [ 80%]  (Adaptation)
Chain 1: Iteration: 250 / 250 [100%]  (Adaptation)
Chain 1: Success! Found best value [eta = 0.1].
Chain 1: 
Chain 1: Begin stochastic gradient ascent.
Chain 1:   iter             ELBO   delta_ELBO_mean   delta_ELBO_med   notes 
Chain 1:    100     -1570572.728             1.000            1.000
Chain 1:    200     -2509069.245             0.687            1.000
Chain 1:    300     -1147790.101             0.780            1.186
Chain 1:    400      -834083.132             0.781            1.186
Chain 1:    500     -5679402.311             0.615            0.853
Chain 1:    600     -1941955.052             1.389            1.925
Chain 1:    700      -801479.661             1.674            1.925
Chain 1:    800     -3334258.175             1.091            1.423
Chain 1:    900     -1344409.066             1.120            1.480
Chain 1:   1000     -1402021.976             0.761            1.480
Chain 1:   1100     -2747478.626             0.265            0.490
Chain 1:   1200      -718264.802             1.657            2.825   MAY BE DIVERGING... INSPECT ELBO
Chain 1:   1300      -572418.060             1.540            2.825   MAY BE DIVERGING... INSPECT ELBO
Chain 1:   1400      -850924.894             0.291            0.327
Chain 1:   1500      -655335.368             0.313            0.327
Chain 1:   1600     -1619042.102             0.447            0.595   MAY BE DIVERGING... INSPECT ELBO
Chain 1:   1700      -860072.591             0.739            0.882   MAY BE DIVERGING... INSPECT ELBO
Chain 1:   1800      -969877.707             0.498            0.882   MAY BE DIVERGING... INSPECT ELBO
Chain 1:   1900      -460214.634             0.610            1.107   MAY BE DIVERGING... INSPECT ELBO
Chain 1:   2000      -835518.060             0.778            1.107   MAY BE DIVERGING... INSPECT ELBO
Chain 1: Informational Message: The maximum number of iterations is reached! The algorithm may not have converged.
Chain 1: This variational approximation is not guaranteed to be meaningful.
Chain 1: 
Chain 1: Drawing a sample of size 1000 from the approximate posterior... 
Chain 1: COMPLETED.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Pareto k diagnostic value is Inf. Resampling is disabled. Decreasing
tol_rel_obj may help if variational algorithm has terminated prematurely.
Otherwise consider using sampling instead.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity; sigma = identity 
Formula: G3 ~ school + sex + age + address + famsize + Pstatus + Medu + Fedu + Mjob + Fjob + reason + guardian + traveltime + studytime + failures + schoolsup + famsup + paid + activities + nursery + higher + internet + romantic + famrel + freetime + goout + Dalc + Walc + health + absences + G1 + G2 
   Data: dat (Number of observations: 395) 
  Draws: 1 chains, each with iter = 1000; warmup = 0; thin = 1;
         total post-warmup draws = 1000

Regression Coefficients:
                 Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept           -0.95     11.97   -22.98    25.49 1.00      849      903
schoolMS             0.10      0.35    -0.42     0.87 1.00     1068     1069
sexM                 0.45      0.84    -1.08     2.43 1.00      997      873
age                 -0.11      0.45    -1.14     0.55 1.00      974      941
addressU             0.90      0.85    -0.18     3.11 1.00     1045      797
famsizeLE3           0.11      0.41    -0.52     1.07 1.00      930      689
PstatusT            -0.05      0.75    -1.70     1.44 1.00      912      870
Medu                 0.49      0.74    -0.56     2.43 1.00      901      944
Fedu                 0.66      0.64     0.00     2.24 1.00      663      748
Mjobhealth          -0.10      0.56    -1.50     1.01 1.00      872      973
Mjobother            0.17      0.53    -0.82     1.40 1.00      972      890
Mjobservices         0.54      0.63     0.00     2.33 1.00      898      941
Mjobteacher         -0.56      0.63    -2.14     0.10 1.00     1027      743
Fjobhealth          -0.27      0.43    -1.47     0.05 1.00      988      962
Fjobother           -0.04      0.22    -0.52     0.29 1.00     1062      916
Fjobservices        -0.88      0.84    -2.83     0.25 1.00      905      956
Fjobteacher          0.24      0.68    -1.09     1.76 1.00     1102      981
reasonhome           0.02      0.34    -0.60     0.83 1.00      957      945
reasonother         -0.25      0.47    -1.51     0.43 1.00      924      901
reasonreputation     0.44      0.80    -0.95     2.37 1.00      962      919
guardianmother       0.55      0.76    -0.75     2.29 1.00     1009      918
guardianother        0.06      0.23    -0.31     0.65 1.00      882      986
traveltime           0.30      0.41    -0.09     1.46 1.00      924      952
studytime            0.28      0.42    -0.08     1.43 1.00      943     1021
failures             0.47      0.93    -1.02     2.54 1.00      962      881
schoolsupyes        -0.01      0.24    -0.57     0.49 1.00      953     1012
famsupyes           -0.30      0.53    -1.74     0.34 1.00      912      907
paidyes             -0.03      0.50    -0.96     1.09 1.00      901      906
activitiesyes       -0.25      0.41    -1.32     0.29 1.00      992     1003
nurseryyes          -0.37      0.63    -1.89     0.67 1.00      995      903
higheryes           -0.19      0.85    -1.95     1.42 1.00      660      799
internetyes          0.20      0.75    -1.09     1.95 1.00     1020     1071
romanticyes          0.08      0.32    -0.49     0.90 1.00      861      916
famrel               0.79      0.78    -0.16     2.79 1.00      949      751
freetime             0.13      0.25    -0.10     0.79 1.00      782     1023
goout                0.08      0.35    -0.56     0.91 1.00     1063      978
Dalc                -0.71      0.75    -2.69     0.10 1.00      958      879
Walc                 1.24      1.05    -0.13     3.72 1.00     1122      725
health              -0.16      0.27    -0.82     0.05 1.00     1106      908
absences            -0.40      0.68    -1.88     0.70 1.00      813      908
G1                  -0.24      0.36    -1.17     0.03 1.00      896      820
G2                  -0.28      0.44    -1.58     0.25 1.00     1013      912

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma     0.66      0.62     0.10     2.24 1.00      957      944

Draws were sampled using variational(fullrank). </code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>runtime3 <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The running time for the different models is:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
  method    run_time     
  &lt;chr&gt;     &lt;drtn&gt;       
1 HMC       38.41162 secs
2 Meanfield 23.35223 secs
3 Fullrank  24.01643 secs</code></pre>
</div>
</div>
<p>The Non-MCMC methods are a bit quicker. Note that a very large part of this is due to the compilation of the model and not the estimation itself.</p>
<p>Let’s compare the coefficients for the previous test scores in period 1 <em>G1</em> and period 2 <em>G2</em>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>df_plot <span class="ot">=</span> <span class="fu">tibble</span>(</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">Method =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"HMC"</span>, <span class="dv">2</span>), <span class="fu">rep</span>(<span class="st">"Meanfield"</span>, <span class="dv">2</span>), <span class="fu">rep</span>(<span class="st">"Fullrank"</span>, <span class="dv">2</span>)),</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">Coef =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"G1"</span>, <span class="st">"G2"</span>), <span class="dv">3</span>),</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">Estimate =</span> <span class="fu">c</span>(</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summary</span>(fit1)<span class="sc">$</span>fixed[<span class="dv">41</span><span class="sc">:</span><span class="dv">42</span>, ]<span class="sc">$</span>Estimate,</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summary</span>(fit2)<span class="sc">$</span>fixed[<span class="dv">41</span><span class="sc">:</span><span class="dv">42</span>, ]<span class="sc">$</span>Estimate,</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summary</span>(fit3)<span class="sc">$</span>fixed[<span class="dv">41</span><span class="sc">:</span><span class="dv">42</span>, ]<span class="sc">$</span>Estimate</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: There were 10 divergent transitions after warmup. Increasing
adapt_delta above 0.8 may help. See
http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>df_plot <span class="sc">%&gt;%</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Coef, <span class="at">y =</span> Estimate, <span class="at">color =</span> Method)) <span class="sc">+</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">5</span>, <span class="at">alpha =</span> <span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Non-MCMC_methods_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We see that HMC and Meanfield obtain comparable results, while Fullrank is quite far off.</p>
<section id="running-models-direclty-in-cmdstanr" class="level3">
<h3 class="anchored" data-anchor-id="running-models-direclty-in-cmdstanr">Running models direclty in CMDSTANR</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cmdstanr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>This is cmdstanr version 0.8.1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>- CmdStanR documentation and vignettes: mc-stan.org/cmdstanr</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>- CmdStan path: /Users/Erp00018/.cmdstan/cmdstan-2.36.0</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>- CmdStan version: 2.36.0</code></pre>
</div>
</div>
<p>For some methods it can be easier to run the model with <code>cmdstanr</code> This can feel a bit daunting, since <code>cmdstanr</code> does not work with specifying formulas like <code>brm</code> or <code>lm</code>. Instead we need to write the model in <code>Stan</code>. Luckily for us the <code>brms</code> package has a function <em>stancode</em>, to obtain a stan program given a formula:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># obtain model code</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>model_code <span class="ot">&lt;-</span> <span class="fu">stancode</span>(G3 <span class="sc">~</span> ., <span class="at">family =</span> <span class="fu">gaussian</span>(), <span class="at">data =</span> dat, <span class="at">algorithm =</span> <span class="st">"sampling"</span>, <span class="at">prior =</span> hs_prior)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>model_code</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>// generated with brms 2.22.0
functions {
  /* Efficient computation of the horseshoe scale parameters
   * see Appendix C.1 in https://projecteuclid.org/euclid.ejs/1513306866
   * Args:
   *   lambda: local shrinkage parameters
   *   tau: global shrinkage parameter
   *   c2: slap regularization parameter
   * Returns:
   *   scale parameter vector of the horseshoe prior
   */
  vector scales_horseshoe(vector lambda, real tau, real c2) {
    int K = rows(lambda);
    vector[K] lambda2 = square(lambda);
    vector[K] lambda_tilde = sqrt(c2 * lambda2 ./ (c2 + tau^2 * lambda2));
    return lambda_tilde * tau;
  }
}
data {
  int&lt;lower=1&gt; N;  // total number of observations
  vector[N] Y;  // response variable
  int&lt;lower=1&gt; K;  // number of population-level effects
  matrix[N, K] X;  // population-level design matrix
  int&lt;lower=1&gt; Kc;  // number of population-level effects after centering
  int&lt;lower=1&gt; Kscales;  // number of local scale parameters
  // data for the horseshoe prior
  real&lt;lower=0&gt; hs_df;  // local degrees of freedom
  real&lt;lower=0&gt; hs_df_global;  // global degrees of freedom
  real&lt;lower=0&gt; hs_df_slab;  // slab degrees of freedom
  real&lt;lower=0&gt; hs_scale_global;  // global prior scale
  real&lt;lower=0&gt; hs_scale_slab;  // slab prior scale
  int prior_only;  // should the likelihood be ignored?
}
transformed data {
  matrix[N, Kc] Xc;  // centered version of X without an intercept
  vector[Kc] means_X;  // column means of X before centering
  for (i in 2:K) {
    means_X[i - 1] = mean(X[, i]);
    Xc[, i - 1] = X[, i] - means_X[i - 1];
  }
}
parameters {
  vector[Kc] zb;  // unscaled coefficients
  real Intercept;  // temporary intercept for centered predictors
  // horseshoe shrinkage parameters
  real&lt;lower=0&gt; hs_global;  // global shrinkage parameter
  real&lt;lower=0&gt; hs_slab;  // slab regularization parameter
  vector&lt;lower=0&gt;[Kscales] hs_local;  // local parameters for the horseshoe prior
  real&lt;lower=0&gt; sigma;  // dispersion parameter
}
transformed parameters {
  vector[Kc] b;  // scaled coefficients
  vector&lt;lower=0&gt;[Kc] sdb;  // SDs of the coefficients
  vector&lt;lower=0&gt;[Kscales] scales;  // local horseshoe scale parameters
  real lprior = 0;  // prior contributions to the log posterior
  // compute horseshoe scale parameters
  scales = scales_horseshoe(hs_local, hs_global, hs_scale_slab^2 * hs_slab);
  sdb = scales[(1):(Kc)];
  b = zb .* sdb;  // scale coefficients
  lprior += student_t_lpdf(Intercept | 3, 11, 4.4);
  lprior += student_t_lpdf(hs_global | hs_df_global, 0, hs_scale_global * sigma)
    - 1 * log(0.5);
  lprior += inv_gamma_lpdf(hs_slab | 0.5 * hs_df_slab, 0.5 * hs_df_slab);
  lprior += student_t_lpdf(sigma | 3, 0, 4.4)
    - 1 * student_t_lccdf(0 | 3, 0, 4.4);
}
model {
  // likelihood including constants
  if (!prior_only) {
    target += normal_id_glm_lpdf(Y | Xc, Intercept, b, sigma);
  }
  // priors including constants
  target += lprior;
  target += std_normal_lpdf(zb);
  target += student_t_lpdf(hs_local | hs_df, 0, 1)
    - rows(hs_local) * log(0.5);
}
generated quantities {
  // actual population-level intercept
  real b_Intercept = Intercept - dot_product(means_X, b);
}</code></pre>
</div>
</div>
<p>This saves us a considerable amount of work. <code>cmdstanr</code> also has a specific way it wants the data, namely a list with the arguments in the data block above. This can be obtained with the <em>standata</em> function. And finally, we need to compile the model. The advantage of using <code>cmdstanr</code> is that it offers more flexibility.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># obtain data in the right format</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>model_data <span class="ot">&lt;-</span> <span class="fu">standata</span>(G3 <span class="sc">~</span> ., <span class="at">family =</span> <span class="fu">gaussian</span>(), <span class="at">data =</span> dat, <span class="at">algorithm =</span> <span class="st">"sampling"</span>, <span class="at">prior =</span> hs_prior)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(model_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 12
 $ N              : int 395
 $ Y              : int [1:395(1d)] 6 6 10 15 10 15 11 6 19 15 ...
 $ K              : int 42
 $ Kc             : num 41
 $ X              : num [1:395, 1:42] 1 1 1 1 1 1 1 1 1 1 ...
  ..- attr(*, "dimnames")=List of 2
  .. ..$ : chr [1:395] "1" "2" "3" "4" ...
  .. ..$ : chr [1:42] "Intercept" "schoolMS" "sexM" "age" ...
  ..- attr(*, "assign")= int [1:42] 0 1 2 3 4 5 6 7 8 9 ...
  ..- attr(*, "contrasts")=List of 17
  .. ..$ school    : chr "contr.treatment"
  .. ..$ sex       : chr "contr.treatment"
  .. ..$ address   : chr "contr.treatment"
  .. ..$ famsize   : chr "contr.treatment"
  .. ..$ Pstatus   : chr "contr.treatment"
  .. ..$ Mjob      : chr "contr.treatment"
  .. ..$ Fjob      : chr "contr.treatment"
  .. ..$ reason    : chr "contr.treatment"
  .. ..$ guardian  : chr "contr.treatment"
  .. ..$ schoolsup : chr "contr.treatment"
  .. ..$ famsup    : chr "contr.treatment"
  .. ..$ paid      : chr "contr.treatment"
  .. ..$ activities: chr "contr.treatment"
  .. ..$ nursery   : chr "contr.treatment"
  .. ..$ higher    : chr "contr.treatment"
  .. ..$ internet  : chr "contr.treatment"
  .. ..$ romantic  : chr "contr.treatment"
 $ Kscales        : num 41
 $ hs_df          : num 3
 $ hs_df_global   : num 1
 $ hs_df_slab     : num 4
 $ hs_scale_global: num 1
 $ hs_scale_slab  : num 2
 $ prior_only     : int 0
 - attr(*, "class")= chr [1:2] "standata" "list"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># compile the model</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>m_compiled <span class="ot">&lt;-</span> cmdstanr<span class="sc">::</span><span class="fu">cmdstan_model</span>(cmdstanr<span class="sc">::</span><span class="fu">write_stan_file</span>(model_code))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Below we run two extra models: a Laplace approximation and a Pathfinder <a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> approximation of which the results are subsequently used as initial values for HMC:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># laplace</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>model_lp <span class="ot">&lt;-</span> m_compiled<span class="sc">$</span><span class="fu">laplace</span>(<span class="at">data =</span> model_data, <span class="at">seed =</span> <span class="dv">123</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Initial log joint probability = -1.00441e+06 
    Iter      log prob        ||dx||      ||grad||       alpha      alpha0  # evals  Notes  
Exception: student_t_lpdf: Scale parameter is inf, but must be positive finite! (in '/var/folders/_n/t9lx5kvs1qbgkx8nb8cxfy4r0000gn/T/RtmpAipoiE/model-249e952e8a0.stan', line 61, column 2 to line 62, column 19) 
Exception: student_t_lpdf: Scale parameter is inf, but must be positive finite! (in '/var/folders/_n/t9lx5kvs1qbgkx8nb8cxfy4r0000gn/T/RtmpAipoiE/model-249e952e8a0.stan', line 61, column 2 to line 62, column 19) 
Error evaluating model log probability: Non-finite function evaluation. 
Exception: normal_id_glm_lpdf: Matrix of independent variables is inf, but must be finite! (in '/var/folders/_n/t9lx5kvs1qbgkx8nb8cxfy4r0000gn/T/RtmpAipoiE/model-249e952e8a0.stan', line 70, column 4 to column 62) 
Exception: normal_id_glm_lpdf: Matrix of independent variables is inf, but must be finite! (in '/var/folders/_n/t9lx5kvs1qbgkx8nb8cxfy4r0000gn/T/RtmpAipoiE/model-249e952e8a0.stan', line 70, column 4 to column 62) 
      99       -881.19      0.589956       43.4094           1           1      174    
    Iter      log prob        ||dx||      ||grad||       alpha      alpha0  # evals  Notes  
     199      -872.053     0.0088016       3.96852      0.4371      0.4371      289    
    Iter      log prob        ||dx||      ||grad||       alpha      alpha0  # evals  Notes  
     299      -871.982    0.00227751      0.779228           1           1      401    
    Iter      log prob        ||dx||      ||grad||       alpha      alpha0  # evals  Notes  
     390       -871.98   6.23698e-05     0.0574599           1           1      506    
Optimization terminated normally:  
  Convergence detected: relative gradient magnitude is below tolerance 
Finished in  0.2 seconds.
Calculating Hessian 
Calculating inverse of Cholesky factor 
Generating draws 
iteration: 0 
iteration: 100 
iteration: 200 
iteration: 300 
iteration: 400 
iteration: 500 
iteration: 600 
iteration: 700 
iteration: 800 
iteration: 900 
Finished in  0.1 seconds.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pathfinder</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>model_pf <span class="ot">&lt;-</span> m_compiled<span class="sc">$</span><span class="fu">pathfinder</span>(<span class="at">data =</span> model_data, <span class="at">seed =</span> <span class="dv">123</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Path [1] :Initial log joint density = -1004410.592741 
Exception: student_t_lpdf: Scale parameter is inf, but must be positive finite! (in '/var/folders/_n/t9lx5kvs1qbgkx8nb8cxfy4r0000gn/T/RtmpAipoiE/model-249e952e8a0.stan', line 61, column 2 to line 62, column 19) 
Exception: student_t_lpdf: Scale parameter is inf, but must be positive finite! (in '/var/folders/_n/t9lx5kvs1qbgkx8nb8cxfy4r0000gn/T/RtmpAipoiE/model-249e952e8a0.stan', line 61, column 2 to line 62, column 19) 
Error evaluating model log probability: Non-finite function evaluation. 
Exception: normal_id_glm_lpdf: Matrix of independent variables is inf, but must be finite! (in '/var/folders/_n/t9lx5kvs1qbgkx8nb8cxfy4r0000gn/T/RtmpAipoiE/model-249e952e8a0.stan', line 70, column 4 to column 62) 
Exception: normal_id_glm_lpdf: Matrix of independent variables is inf, but must be finite! (in '/var/folders/_n/t9lx5kvs1qbgkx8nb8cxfy4r0000gn/T/RtmpAipoiE/model-249e952e8a0.stan', line 70, column 4 to column 62) 
Path [1] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  
             99      -8.812e+02      5.900e-01   4.341e+01    1.000e+00  1.000e+00      2476 -9.603e+02 -9.603e+02                   
Path [1] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  
            199      -8.721e+02      8.802e-03   3.969e+00    4.371e-01  4.371e-01      4976 -1.043e+03 -1.043e+03                   
Path [1] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  
            299      -8.720e+02      2.278e-03   7.792e-01    1.000e+00  1.000e+00      7476 -1.037e+03 -1.037e+03                   
Path [1] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  
            390      -8.720e+02      6.237e-05   5.746e-02    1.000e+00  1.000e+00      9751 -1.039e+03 -1.039e+03                   
Path [1] :Best Iter: [102] ELBO (-948.175274) evaluations: (9751) 
Path [2] :Initial log joint density = -6782.162576 
Path [2] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  
             99      -8.744e+02      8.100e-02   8.050e+00    1.000e+00  1.000e+00      2476 -9.897e+02 -9.897e+02                   
Path [2] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  
            199      -8.720e+02      2.677e-03   3.579e+00    1.000e+00  1.000e+00      4976 -1.012e+03 -1.012e+03                   
Path [2] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  
            299      -8.720e+02      2.856e-03   1.155e+00    1.000e+00  1.000e+00      7476 -1.022e+03 -1.022e+03                   
Path [2] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  
            386      -8.720e+02      1.001e-04   7.737e-02    1.000e+00  1.000e+00      9651 -1.037e+03 -1.037e+03                   
Path [2] :Best Iter: [62] ELBO (-933.275817) evaluations: (9651) 
Path [3] :Initial log joint density = -1999.794678 
Path [3] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  
             99      -8.753e+02      3.164e-02   8.192e+00    9.729e-01  9.729e-01      2476 -9.731e+02 -9.731e+02                   
Path [3] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  
            199      -8.720e+02      3.502e-03   1.624e+00    8.884e-02  1.000e+00      4976 -1.075e+03 -1.075e+03                   
Path [3] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  
            299      -8.720e+02      2.505e-04   2.006e-01    1.000e+00  1.000e+00      7476 -9.756e+02 -9.756e+02                   
Path [3] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  
            308      -8.720e+02      2.559e-04   6.874e-02    1.000e+00  1.000e+00      7701 -9.884e+02 -9.884e+02                   
Path [3] :Best Iter: [55] ELBO (-927.882732) evaluations: (7701) 
Path [4] :Initial log joint density = -44656.679535 
Error evaluating model log probability: Non-finite gradient. 
Path [4] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  
             99      -8.746e+02      2.739e-02   1.295e+01    1.000e+00  1.000e+00      2476 -1.045e+03 -1.045e+03                   
Path [4] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  
            199      -8.720e+02      1.046e-02   1.723e+00    1.000e+00  1.000e+00      4976 -1.007e+03 -1.007e+03                   
Path [4] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  
            299      -8.720e+02      3.481e-04   2.616e-01    2.763e-01  2.763e-01      7476 -9.875e+02 -9.875e+02                   
Path [4] : Iter      log prob        ||dx||      ||grad||     alpha      alpha0      # evals       ELBO    Best ELBO        Notes  
            350      -8.720e+02      9.476e-05   1.196e-01    1.000e+00  1.000e+00      8751 -1.017e+03 -1.017e+03                   
Path [4] :Best Iter: [56] ELBO (-950.696632) evaluations: (8751) 
Total log probability function evaluations:39754 
Pareto k value (3.9) is greater than 0.7. Importance resampling was not able to improve the approximation, which may indicate that the approximation itself is poor. 
Finished in  0.3 seconds.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># supply pathfinder results as inital values for HMC</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>model_pf_hmc <span class="ot">&lt;-</span> m_compiled<span class="sc">$</span><span class="fu">sample</span>(<span class="at">data =</span> model_data, <span class="at">seed =</span> <span class="dv">123</span>, <span class="at">init =</span> model_pf, <span class="at">iter_warmup =</span> <span class="dv">100</span>, <span class="at">iter_sampling =</span> <span class="dv">2000</span>, <span class="at">chains =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 sequential chains...

Chain 1 WARNING: There aren't enough warmup iterations to fit the 
Chain 1          three stages of adaptation as currently configured. 
Chain 1          Reducing each adaptation stage to 15%/75%/10% of 
Chain 1          the given number of warmup iterations: 
Chain 1            init_buffer = 15 
Chain 1            adapt_window = 75 
Chain 1            term_buffer = 10 
Chain 1 Iteration:    1 / 2100 [  0%]  (Warmup) 
Chain 1 Iteration:  100 / 2100 [  4%]  (Warmup) 
Chain 1 Iteration:  101 / 2100 [  4%]  (Sampling) 
Chain 1 Iteration:  200 / 2100 [  9%]  (Sampling) 
Chain 1 Iteration:  300 / 2100 [ 14%]  (Sampling) 
Chain 1 Iteration:  400 / 2100 [ 19%]  (Sampling) 
Chain 1 Iteration:  500 / 2100 [ 23%]  (Sampling) 
Chain 1 Iteration:  600 / 2100 [ 28%]  (Sampling) 
Chain 1 Iteration:  700 / 2100 [ 33%]  (Sampling) 
Chain 1 Iteration:  800 / 2100 [ 38%]  (Sampling) 
Chain 1 Iteration:  900 / 2100 [ 42%]  (Sampling) 
Chain 1 Iteration: 1000 / 2100 [ 47%]  (Sampling) 
Chain 1 Iteration: 1100 / 2100 [ 52%]  (Sampling) 
Chain 1 Iteration: 1200 / 2100 [ 57%]  (Sampling) 
Chain 1 Iteration: 1300 / 2100 [ 61%]  (Sampling) 
Chain 1 Iteration: 1400 / 2100 [ 66%]  (Sampling) 
Chain 1 Iteration: 1500 / 2100 [ 71%]  (Sampling) 
Chain 1 Iteration: 1600 / 2100 [ 76%]  (Sampling) 
Chain 1 Iteration: 1700 / 2100 [ 80%]  (Sampling) 
Chain 1 Iteration: 1800 / 2100 [ 85%]  (Sampling) 
Chain 1 Iteration: 1900 / 2100 [ 90%]  (Sampling) 
Chain 1 Iteration: 2000 / 2100 [ 95%]  (Sampling) 
Chain 1 Iteration: 2100 / 2100 [100%]  (Sampling) 
Chain 1 finished in 5.3 seconds.
Chain 2 WARNING: There aren't enough warmup iterations to fit the 
Chain 2          three stages of adaptation as currently configured. 
Chain 2          Reducing each adaptation stage to 15%/75%/10% of 
Chain 2          the given number of warmup iterations: 
Chain 2            init_buffer = 15 
Chain 2            adapt_window = 75 
Chain 2            term_buffer = 10 
Chain 2 Iteration:    1 / 2100 [  0%]  (Warmup) </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 Exception: student_t_lpdf: Scale parameter is inf, but must be positive finite! (in '/var/folders/_n/t9lx5kvs1qbgkx8nb8cxfy4r0000gn/T/RtmpAipoiE/model-249e952e8a0.stan', line 61, column 2 to line 62, column 19)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 2 Iteration:  100 / 2100 [  4%]  (Warmup) 
Chain 2 Iteration:  101 / 2100 [  4%]  (Sampling) 
Chain 2 Iteration:  200 / 2100 [  9%]  (Sampling) 
Chain 2 Iteration:  300 / 2100 [ 14%]  (Sampling) 
Chain 2 Iteration:  400 / 2100 [ 19%]  (Sampling) 
Chain 2 Iteration:  500 / 2100 [ 23%]  (Sampling) 
Chain 2 Iteration:  600 / 2100 [ 28%]  (Sampling) 
Chain 2 Iteration:  700 / 2100 [ 33%]  (Sampling) 
Chain 2 Iteration:  800 / 2100 [ 38%]  (Sampling) 
Chain 2 Iteration:  900 / 2100 [ 42%]  (Sampling) 
Chain 2 Iteration: 1000 / 2100 [ 47%]  (Sampling) 
Chain 2 Iteration: 1100 / 2100 [ 52%]  (Sampling) 
Chain 2 Iteration: 1200 / 2100 [ 57%]  (Sampling) 
Chain 2 Iteration: 1300 / 2100 [ 61%]  (Sampling) 
Chain 2 Iteration: 1400 / 2100 [ 66%]  (Sampling) 
Chain 2 Iteration: 1500 / 2100 [ 71%]  (Sampling) 
Chain 2 Iteration: 1600 / 2100 [ 76%]  (Sampling) 
Chain 2 Iteration: 1700 / 2100 [ 80%]  (Sampling) 
Chain 2 Iteration: 1800 / 2100 [ 85%]  (Sampling) 
Chain 2 Iteration: 1900 / 2100 [ 90%]  (Sampling) 
Chain 2 Iteration: 2000 / 2100 [ 95%]  (Sampling) 
Chain 2 Iteration: 2100 / 2100 [100%]  (Sampling) 
Chain 2 finished in 5.4 seconds.
Chain 3 WARNING: There aren't enough warmup iterations to fit the 
Chain 3          three stages of adaptation as currently configured. 
Chain 3          Reducing each adaptation stage to 15%/75%/10% of 
Chain 3          the given number of warmup iterations: 
Chain 3            init_buffer = 15 
Chain 3            adapt_window = 75 
Chain 3            term_buffer = 10 
Chain 3 Iteration:    1 / 2100 [  0%]  (Warmup) </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Exception: student_t_lpdf: Scale parameter is 0, but must be positive finite! (in '/var/folders/_n/t9lx5kvs1qbgkx8nb8cxfy4r0000gn/T/RtmpAipoiE/model-249e952e8a0.stan', line 61, column 2 to line 62, column 19)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 3 Iteration:  100 / 2100 [  4%]  (Warmup) 
Chain 3 Iteration:  101 / 2100 [  4%]  (Sampling) 
Chain 3 Iteration:  200 / 2100 [  9%]  (Sampling) 
Chain 3 Iteration:  300 / 2100 [ 14%]  (Sampling) 
Chain 3 Iteration:  400 / 2100 [ 19%]  (Sampling) 
Chain 3 Iteration:  500 / 2100 [ 23%]  (Sampling) 
Chain 3 Iteration:  600 / 2100 [ 28%]  (Sampling) 
Chain 3 Iteration:  700 / 2100 [ 33%]  (Sampling) 
Chain 3 Iteration:  800 / 2100 [ 38%]  (Sampling) 
Chain 3 Iteration:  900 / 2100 [ 42%]  (Sampling) 
Chain 3 Iteration: 1000 / 2100 [ 47%]  (Sampling) 
Chain 3 Iteration: 1100 / 2100 [ 52%]  (Sampling) 
Chain 3 Iteration: 1200 / 2100 [ 57%]  (Sampling) 
Chain 3 Iteration: 1300 / 2100 [ 61%]  (Sampling) 
Chain 3 Iteration: 1400 / 2100 [ 66%]  (Sampling) 
Chain 3 Iteration: 1500 / 2100 [ 71%]  (Sampling) 
Chain 3 Iteration: 1600 / 2100 [ 76%]  (Sampling) 
Chain 3 Iteration: 1700 / 2100 [ 80%]  (Sampling) 
Chain 3 Iteration: 1800 / 2100 [ 85%]  (Sampling) 
Chain 3 Iteration: 1900 / 2100 [ 90%]  (Sampling) 
Chain 3 Iteration: 2000 / 2100 [ 95%]  (Sampling) 
Chain 3 Iteration: 2100 / 2100 [100%]  (Sampling) 
Chain 3 finished in 5.4 seconds.
Chain 4 WARNING: There aren't enough warmup iterations to fit the 
Chain 4          three stages of adaptation as currently configured. 
Chain 4          Reducing each adaptation stage to 15%/75%/10% of 
Chain 4          the given number of warmup iterations: 
Chain 4            init_buffer = 15 
Chain 4            adapt_window = 75 
Chain 4            term_buffer = 10 
Chain 4 Iteration:    1 / 2100 [  0%]  (Warmup) </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Exception: student_t_lpdf: Scale parameter is inf, but must be positive finite! (in '/var/folders/_n/t9lx5kvs1qbgkx8nb8cxfy4r0000gn/T/RtmpAipoiE/model-249e952e8a0.stan', line 61, column 2 to line 62, column 19)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 4 Iteration:  100 / 2100 [  4%]  (Warmup) 
Chain 4 Iteration:  101 / 2100 [  4%]  (Sampling) 
Chain 4 Iteration:  200 / 2100 [  9%]  (Sampling) 
Chain 4 Iteration:  300 / 2100 [ 14%]  (Sampling) 
Chain 4 Iteration:  400 / 2100 [ 19%]  (Sampling) 
Chain 4 Iteration:  500 / 2100 [ 23%]  (Sampling) 
Chain 4 Iteration:  600 / 2100 [ 28%]  (Sampling) 
Chain 4 Iteration:  700 / 2100 [ 33%]  (Sampling) 
Chain 4 Iteration:  800 / 2100 [ 38%]  (Sampling) 
Chain 4 Iteration:  900 / 2100 [ 42%]  (Sampling) 
Chain 4 Iteration: 1000 / 2100 [ 47%]  (Sampling) 
Chain 4 Iteration: 1100 / 2100 [ 52%]  (Sampling) 
Chain 4 Iteration: 1200 / 2100 [ 57%]  (Sampling) 
Chain 4 Iteration: 1300 / 2100 [ 61%]  (Sampling) 
Chain 4 Iteration: 1400 / 2100 [ 66%]  (Sampling) 
Chain 4 Iteration: 1500 / 2100 [ 71%]  (Sampling) 
Chain 4 Iteration: 1600 / 2100 [ 76%]  (Sampling) 
Chain 4 Iteration: 1700 / 2100 [ 80%]  (Sampling) 
Chain 4 Iteration: 1800 / 2100 [ 85%]  (Sampling) 
Chain 4 Iteration: 1900 / 2100 [ 90%]  (Sampling) 
Chain 4 Iteration: 2000 / 2100 [ 95%]  (Sampling) 
Chain 4 Iteration: 2100 / 2100 [100%]  (Sampling) 
Chain 4 finished in 5.4 seconds.

All 4 chains finished successfully.
Mean chain execution time: 5.4 seconds.
Total execution time: 21.8 seconds.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: 4 of 8000 (0.0%) transitions ended with a divergence.
See https://mc-stan.org/misc/warnings for details.</code></pre>
</div>
</div>
<p>Let’s compare these results to what we obtained before:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>lp_est <span class="ot">=</span> model_lp<span class="sc">$</span><span class="fu">summary</span>() <span class="sc">|&gt;</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(variable <span class="sc">==</span> <span class="st">"b[40]"</span> <span class="sc">|</span> variable <span class="sc">==</span> <span class="st">"b[41]"</span>) </span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>pf_est <span class="ot">=</span> model_pf<span class="sc">$</span><span class="fu">summary</span>() <span class="sc">|&gt;</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(variable <span class="sc">==</span> <span class="st">"b[40]"</span> <span class="sc">|</span> variable <span class="sc">==</span> <span class="st">"b[41]"</span>) </span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>hmc_pf_est <span class="ot">=</span> model_pf_hmc<span class="sc">$</span><span class="fu">summary</span>() <span class="sc">|&gt;</span></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(variable <span class="sc">==</span> <span class="st">"b[40]"</span> <span class="sc">|</span> variable <span class="sc">==</span> <span class="st">"b[41]"</span>) </span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>df_plot2 <span class="ot">=</span> <span class="fu">tibble</span>(</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">Method =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"Laplace"</span>, <span class="dv">2</span>), <span class="fu">rep</span>(<span class="st">"Pathfinder"</span>, <span class="dv">2</span>), <span class="fu">rep</span>(<span class="st">"Pathfinder -&gt; HMC"</span>, <span class="dv">2</span>)),</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">Coef =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"G1"</span>, <span class="st">"G2"</span>), <span class="dv">3</span>),</span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">Estimate =</span> <span class="fu">c</span>(lp_est<span class="sc">$</span>mean ,pf_est<span class="sc">$</span>mean , hmc_pf_est<span class="sc">$</span>mean ))</span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a><span class="fu">rbind</span>(df_plot, df_plot2) <span class="sc">%&gt;%</span> </span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Coef, <span class="at">y =</span> Estimate, <span class="at">color =</span> Method)) <span class="sc">+</span></span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">4</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>Method)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Non-MCMC_methods_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We see that Meanfield, Pathfinder, and Pathfinder -&gt; HMC can get close to HMC. Now of course this does not mean that this is always the case. We should be very careful in using the approximate methods and for example use these methods during the model building stage in which we might want to quickly run multiple iterations of a model, but relying on HMC for the final inferences.</p>
</section>
</section>
<section id="original-computing-environment" class="level2">
<h2 class="anchored" data-anchor-id="original-computing-environment">Original Computing Environment</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">session_info</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>─ Session info ───────────────────────────────────────────────────────────────
 setting  value
 version  R version 4.3.3 (2024-02-29)
 os       macOS 15.5
 system   aarch64, darwin20
 ui       X11
 language (EN)
 collate  en_US.UTF-8
 ctype    en_US.UTF-8
 tz       Europe/Amsterdam
 date     2025-07-02
 pandoc   3.2 @ /Applications/RStudio.app/Contents/Resources/app/quarto/bin/tools/aarch64/ (via rmarkdown)

─ Packages ───────────────────────────────────────────────────────────────────
 package        * version  date (UTC) lib source
 abind            1.4-8    2024-09-12 [2] CRAN (R 4.3.3)
 backports        1.5.0    2024-05-23 [2] CRAN (R 4.3.3)
 bayesplot        1.12.0   2025-04-10 [1] CRAN (R 4.3.3)
 bridgesampling   1.1-2    2021-04-16 [2] CRAN (R 4.3.0)
 brms           * 2.22.0   2024-09-23 [1] CRAN (R 4.3.3)
 Brobdingnag      1.2-9    2022-10-19 [2] CRAN (R 4.3.3)
 cachem           1.1.0    2024-05-16 [2] CRAN (R 4.3.3)
 callr            3.7.6    2024-03-25 [2] CRAN (R 4.3.3)
 checkmate        2.3.2    2024-07-29 [2] CRAN (R 4.3.3)
 cli              3.6.5    2025-04-23 [1] CRAN (R 4.3.3)
 cmdstanr       * 0.8.1    2025-03-03 [1] https://stan-dev.r-universe.dev (R 4.3.3)
 coda             0.19-4.1 2024-01-31 [2] CRAN (R 4.3.3)
 codetools        0.2-19   2023-02-01 [2] CRAN (R 4.3.3)
 colorspace       2.1-1    2024-07-26 [2] CRAN (R 4.3.3)
 data.table       1.16.4   2024-12-06 [2] CRAN (R 4.3.3)
 devtools         2.4.5    2022-10-11 [2] CRAN (R 4.3.0)
 digest           0.6.37   2024-08-19 [2] CRAN (R 4.3.3)
 distributional   0.5.0    2024-09-17 [2] CRAN (R 4.3.3)
 dplyr          * 1.1.4    2023-11-17 [2] CRAN (R 4.3.1)
 ellipsis         0.3.2    2021-04-29 [2] CRAN (R 4.3.3)
 evaluate         1.0.3    2025-01-10 [2] CRAN (R 4.3.3)
 farver           2.1.2    2024-05-13 [2] CRAN (R 4.3.3)
 fastmap          1.2.0    2024-05-15 [2] CRAN (R 4.3.3)
 fs               1.6.5    2024-10-30 [2] CRAN (R 4.3.3)
 generics         0.1.4    2025-05-09 [1] CRAN (R 4.3.3)
 ggplot2        * 3.5.2    2025-04-09 [1] CRAN (R 4.3.3)
 glue             1.8.0    2024-09-30 [2] CRAN (R 4.3.3)
 gridExtra        2.3      2017-09-09 [2] CRAN (R 4.3.3)
 gtable           0.3.6    2024-10-25 [2] CRAN (R 4.3.3)
 htmltools        0.5.8.1  2024-04-04 [2] CRAN (R 4.3.3)
 htmlwidgets      1.6.4    2023-12-06 [2] CRAN (R 4.3.1)
 httpuv           1.6.15   2024-03-26 [2] CRAN (R 4.3.1)
 inline           0.3.21   2025-01-09 [2] CRAN (R 4.3.3)
 jsonlite         1.8.9    2024-09-20 [2] CRAN (R 4.3.3)
 knitr            1.49     2024-11-08 [2] CRAN (R 4.3.3)
 labeling         0.4.3    2023-08-29 [2] CRAN (R 4.3.3)
 later            1.4.1    2024-11-27 [2] CRAN (R 4.3.3)
 lattice          0.22-5   2023-10-24 [2] CRAN (R 4.3.3)
 lifecycle        1.0.4    2023-11-07 [2] CRAN (R 4.3.3)
 loo              2.8.0    2024-07-03 [1] CRAN (R 4.3.3)
 magrittr         2.0.3    2022-03-30 [2] CRAN (R 4.3.3)
 Matrix           1.6-5    2024-01-11 [2] CRAN (R 4.3.3)
 matrixStats      1.5.0    2025-01-07 [2] CRAN (R 4.3.3)
 memoise          2.0.1    2021-11-26 [2] CRAN (R 4.3.3)
 mime             0.12     2021-09-28 [2] CRAN (R 4.3.3)
 miniUI           0.1.1.1  2018-05-18 [2] CRAN (R 4.3.0)
 mvtnorm          1.3-3    2025-01-10 [2] CRAN (R 4.3.3)
 nlme             3.1-164  2023-11-27 [2] CRAN (R 4.3.3)
 pillar           1.10.2   2025-04-05 [1] CRAN (R 4.3.3)
 pkgbuild         1.4.7    2025-03-24 [1] CRAN (R 4.3.3)
 pkgconfig        2.0.3    2019-09-22 [2] CRAN (R 4.3.3)
 pkgload          1.4.0    2024-06-28 [2] CRAN (R 4.3.3)
 plyr             1.8.9    2023-10-02 [2] CRAN (R 4.3.3)
 posterior        1.6.1    2025-02-27 [1] CRAN (R 4.3.3)
 processx         3.8.6    2025-02-21 [1] CRAN (R 4.3.3)
 profvis          0.4.0    2024-09-20 [2] CRAN (R 4.3.3)
 promises         1.3.2    2024-11-28 [2] CRAN (R 4.3.3)
 ps               1.9.1    2025-04-12 [1] CRAN (R 4.3.3)
 purrr            1.0.4    2025-02-05 [1] CRAN (R 4.3.3)
 QuickJSR         1.7.0    2025-03-31 [1] CRAN (R 4.3.3)
 R6               2.6.1    2025-02-15 [1] CRAN (R 4.3.3)
 RColorBrewer     1.1-3    2022-04-03 [2] CRAN (R 4.3.3)
 Rcpp           * 1.0.14   2025-01-12 [2] CRAN (R 4.3.3)
 RcppParallel     5.1.10   2025-01-24 [2] CRAN (R 4.3.3)
 remotes          2.5.0    2024-03-17 [2] CRAN (R 4.3.3)
 reshape2         1.4.4    2020-04-09 [2] CRAN (R 4.3.0)
 rlang            1.1.6    2025-04-11 [1] CRAN (R 4.3.3)
 rmarkdown        2.29     2024-11-04 [2] CRAN (R 4.3.3)
 rstan            2.32.7   2025-03-10 [1] CRAN (R 4.3.3)
 rstantools       2.4.0    2024-01-31 [1] CRAN (R 4.3.3)
 rstudioapi       0.17.1   2024-10-22 [2] CRAN (R 4.3.3)
 scales           1.4.0    2025-04-24 [1] CRAN (R 4.3.3)
 sessioninfo      1.2.2    2021-12-06 [2] CRAN (R 4.3.0)
 shiny            1.10.0   2024-12-14 [2] CRAN (R 4.3.3)
 StanHeaders      2.32.10  2024-07-15 [1] CRAN (R 4.3.3)
 stringi          1.8.7    2025-03-27 [1] CRAN (R 4.3.3)
 stringr          1.5.1    2023-11-14 [2] CRAN (R 4.3.1)
 tensorA          0.36.2.1 2023-12-13 [2] CRAN (R 4.3.3)
 tibble           3.2.1    2023-03-20 [2] CRAN (R 4.3.0)
 tidyr          * 1.3.1    2024-01-24 [2] CRAN (R 4.3.1)
 tidyselect       1.2.1    2024-03-11 [2] CRAN (R 4.3.1)
 urlchecker       1.0.1    2021-11-30 [2] CRAN (R 4.3.3)
 usethis          3.1.0    2024-11-26 [2] CRAN (R 4.3.3)
 utf8             1.2.5    2025-05-01 [1] CRAN (R 4.3.3)
 vctrs            0.6.5    2023-12-01 [2] CRAN (R 4.3.3)
 withr            3.0.2    2024-10-28 [2] CRAN (R 4.3.3)
 xfun             0.50     2025-01-07 [2] CRAN (R 4.3.3)
 xtable           1.8-4    2019-04-21 [2] CRAN (R 4.3.3)
 yaml             2.3.10   2024-07-26 [2] CRAN (R 4.3.3)

 [1] /Users/Erp00018/Library/R/arm64/4.3/library
 [2] /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/library

──────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
</div>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Piironen, J., &amp; Vehtari, A. (2017). Sparsity information and regularization in the horseshoe and other shrinkage priors.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Van Erp, S., Oberski, D. L., &amp; Mulder, J. (2019). Shrinkage priors for Bayesian penalized regression. Journal of Mathematical Psychology, 89, 31-50.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>Hoffman, M. D., &amp; Gelman, A. (2014). The No-U-Turn sampler: adaptively setting path lengths in Hamiltonian Monte Carlo. J. Mach. Learn. Res., 15(1), 1593-1623.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>Kucukelbir, A., Ranganath, R., Gelman, A., &amp; Blei, D. (2015). Automatic variational inference in Stan. Advances in neural information processing systems, 28.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>Zhang, L., Carpenter, B., Gelman, A., &amp; Vehtari, A. (2022). Pathfinder: Parallel quasi-Newton variational inference. Journal of Machine Learning Research, 23(306), 1-49.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>